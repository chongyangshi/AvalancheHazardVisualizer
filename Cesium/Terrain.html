<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <meta name="description" content="An app to visualise avalanche hazards.">
    <title>Avalanche Risk Visualiser</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/requirejs-2.1.20/require.js"></script>
    <script type="text/javascript">
    require.config({
        baseUrl : '../../../Source',
        waitSeconds : 60
    });
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript">
    document.addEventListener('gesturestart', function (e) {
        e.preventDefault();
    });
    </script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    @import url(../templates/bucket.css);
</style>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar">
<div id="terrainMenu"></div>
<div id="aspectMenu"></div>
<div id="datesMenu"></div>
<div id="zoomButtons"></div>
<div id="toggleLighting"></div>
<div id="sampleButtons"></div>
</div>
<script id="cesium_sandcastle_script">
function startup(Cesium) {
    'use strict';
//Sandcastle_Begin
Cesium.BingMapsApi.defaultKey = 'AsGBZY2y5aMkCSpLIeQnGPcn9MWH71z8UK9_cHfEfWiO8tGCjndA6N6uv5QxLje1';

var west = -5.008055;
var south = 56.792807;
var east = -4.988427;
var north = 56.798914;

var rectangle = Cesium.Rectangle.fromDegrees(west, south, east, north);

Cesium.Camera.DEFAULT_VIEW_FACTOR = 0;
Cesium.Camera.DEFAULT_VIEW_RECTANGLE = rectangle;

var viewer = new Cesium.Viewer('cesiumContainer', {
    animation : false,
    timeline: false,
    homeButton : false,
    navigationHelpButton : false,
    baseLayerPicker : false
});

// Add all our layers.
var cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : 'https://assets.agi.com/stk-terrain/world',
    requestWaterMask : true,
    requestVertexNormals : true
});
viewer.terrainProvider = cesiumTerrainProviderMeshes;

var OSCredit = new Cesium.Credit("Ordnance Survey (GB) - Provided By EDINA Digimap Ordnance Survey Service");
var OS5LTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : 'https://terrain.ebornet.com/tilesets/L',
    credit : OSCredit,
});
OS5LTerrainProviderMeshes.cameraPos = [56.80, -5.01];
var OS5GTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : 'https://terrain.ebornet.com/tilesets/G',
    credit : OSCredit,
});
OS5GTerrainProviderMeshes.cameraPos = [56.63, -4.95];
var OS5NCTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : 'https://terrain.ebornet.com/tilesets/NC',
    credit : OSCredit,
});
OS5NCTerrainProviderMeshes.cameraPos = [57.11, -3.65];
var OS5SCTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : 'https://terrain.ebornet.com/tilesets/SC',
    credit : OSCredit,
});
OS5SCTerrainProviderMeshes.cameraPos = [57.06, -3.66];
var OS5TTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : 'https://terrain.ebornet.com/tilesets/T',
    credit : OSCredit,
});
OS5TTerrainProviderMeshes.cameraPos = [57.56, -5.49];
var OS5CMTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : 'https://terrain.ebornet.com/tilesets/CM',
    credit : OSCredit,
});
OS5CMTerrainProviderMeshes.cameraPos = [56.95, -4.60];

var showStaticRisk = '1';
var SAISCredit = new Cesium.Credit("Scottish Avalanche Information Service");
var avalanche_risk_map = new Cesium.UrlTemplateImageryProvider({
    url : 'https://avalanche.ebornet.com/api/imagery/api/v1.0/avalanche_risks/{westDegrees}/{northDegrees}/{eastDegrees}/{southDegrees}?showStaticRisk=' + showStaticRisk,
    hasAlphaChannel : true,
    maximumLevel : 15,
    credit: SAISCredit
});
var aspect_map = new Cesium.UrlTemplateImageryProvider({
    url : 'https://avalanche.ebornet.com/api/imagery/api/v1.0/terrain_aspects/{westDegrees}/{northDegrees}/{eastDegrees}/{southDegrees}',
    hasAlphaChannel : true,
    maximumLevel : 15,
    credit: OSCredit
});
var contour_map = new Cesium.UrlTemplateImageryProvider({
    url : 'https://avalanche.ebornet.com/api/imagery/api/v1.0/contours/{westDegrees}/{northDegrees}/{eastDegrees}/{southDegrees}',
    hasAlphaChannel : true,
    maximumLevel : 15,
    credit: OSCredit
});

var layers = viewer.scene.imageryLayers;
var avalanche_layer = layers.addImageryProvider(avalanche_risk_map);
var contour_layer = layers.addImageryProvider(contour_map);
var aspect_layer = null;

Sandcastle.addToolbarMenu([{
    text : 'OS5 Lochaber Terrain',
    onselect : function() {
        viewer.terrainProvider = OS5LTerrainProviderMeshes;
        viewer.scene.globe.enableLighting = false;
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromRadians(Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[1]), Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[0]) , 2500),
            duration: 1.0
        });
    }
} ,  {
    text : 'OS5 Glencoe Terrain',
    onselect : function() {
        viewer.terrainProvider = OS5GTerrainProviderMeshes;
        viewer.scene.globe.enableLighting = false;
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromRadians(Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[1]), Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[0]) , 2500),
            duration: 1.0
        });
    }
} ,  {
    text : 'OS5 Torridon Terrain',
    onselect : function() {
        viewer.terrainProvider = OS5TTerrainProviderMeshes;
        viewer.scene.globe.enableLighting = false;
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromRadians(Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[1]), Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[0]) , 2500),
            duration: 1.0
        });
    }
} ,  {
    text : 'OS5 Creag Meagaidh Terrain',
    onselect : function() {
        viewer.terrainProvider = OS5CMTerrainProviderMeshes;
        viewer.scene.globe.enableLighting = false;
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromRadians(Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[1]), Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[0]) , 2500),
            duration: 1.0
        });
    }
} ,  {
    text : 'OS5 Northern Cairngorms Terrain',
    onselect : function() {
        viewer.terrainProvider = OS5NCTerrainProviderMeshes;
        viewer.scene.globe.enableLighting = false;
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromRadians(Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[1]), Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[0]) , 2500),
            duration: 1.0
        });
    }
} ,  {
    text : 'OS5 Southern Cairngorms Terrain',
    onselect : function() {
        viewer.terrainProvider = OS5SCTerrainProviderMeshes;
        viewer.scene.globe.enableLighting = false;
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromRadians(Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[1]), Cesium.Math.toRadians(viewer.terrainProvider.cameraPos[0]) , 2500),
            duration: 1.0
        });
    }
}, {
    text : 'STK World Terrain',
    onselect : function() {
        viewer.terrainProvider = cesiumTerrainProviderMeshes;
        viewer.scene.globe.enableLighting = false;
    }
}], 'terrainMenu');


Sandcastle.addToolbarMenu([{
    text : 'View Avalanche Risk Map',
    onselect : function() {
        layers.remove(avalanche_layer, true);
        avalanche_layer = layers.addImageryProvider(avalanche_risk_map);
        layers.remove(aspect_layer, true);
    }
}, {
    text : 'View Terrain Aspect Map',
    onselect : function() {
        layers.remove(aspect_layer);
        aspect_layer = layers.addImageryProvider(aspect_map);
        layers.remove(avalanche_layer, true);
   }
}], 'aspectMenu');


var viewModel = { fogEnabled : true };
Cesium.knockout.track(viewModel);

var safetyWarning = new Cesium.Entity();
safetyWarning.name = "Caution: Safety Warning";
safetyWarning.description = {
    getValue : function() {
        return '<b>This experimental application is not suitable for real-life use!</b> While best efforts have been made, the accuracy of avalanche hazard projections and their generation methods have not been peer reviewed or extensively tested. You are advised to receive adequate training before attempting winter mountaineering, and consult official sources such as the <a href="http://sais.gov.uk">Scottish Avalanche Information Service</a> for avalanche forecasts.';
    }
};
viewer.selectedEntity = safetyWarning;

// Load past forecast dates.

function getCameraCenterPosition(){

    var centerOfScreen = new Cesium.Cartesian2(viewer.canvas.clientWidth / 2, viewer.canvas.clientHeight / 2);
    var ellipsoid = viewer.scene.globe.ellipsoid;
    var cartesian = viewer.camera.pickEllipsoid(centerOfScreen, ellipsoid);
    var cartographic = ellipsoid.cartesianToCartographic(cartesian);
    var longitudeString = Cesium.Math.toDegrees(cartographic.longitude);
    var latitudeString = Cesium.Math.toDegrees(cartographic.latitude);

    return [longitudeString, latitudeString];
}

function switchRiskMap(date) {
    avalanche_risk_map = new Cesium.UrlTemplateImageryProvider({
        url : 'https://avalanche.ebornet.com/api/imagery/api/v1.0/avalanche_risks/{westDegrees}/{northDegrees}/{eastDegrees}/{southDegrees}/' + date + '?showStaticRisk=' + showStaticRisk,
        hasAlphaChannel : true,
        maximumLevel : 15,
        credit: SAISCredit
    });
    layers.remove(avalanche_layer, true);
    avalanche_layer = layers.addImageryProvider(avalanche_risk_map);
}

function loadRiskDates() {
    var positions = getCameraCenterPosition();
    var req_url = 'https://avalanche.ebornet.com/api/data/api/v1.0/forecast_dates/' + positions[0].toString() + '/' + positions[1].toString();
    var switch_functions = [];
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState === XMLHttpRequest.DONE ) {
           if (xmlhttp.status === 200) {
                var dates = JSON.parse(xmlhttp.responseText);
                document.getElementById("datesMenu").innerHTML = "";
                Sandcastle.addToolbarMenu([{
                    text : 'Current SAIS Avalanche Risk (' + dates[0] + ')',
                    value: dates[0]
                }], 'datesMenu');

                var select_menu = document.getElementById("datesMenu").firstChild;
                for (var i = 1; i < select_menu.length; i++) {
                    select_menu.options[i] = null;
                }
                select_menu.addEventListener('change', function(){switchRiskMap(this.value);}, false);
                for (var i = 1; i < dates.length; i++) {
                    var option = document.createElement('option');
                    option.textContent = 'Outdated Forecast on ' + dates[i];
                    option.value = dates[i];
                    document.getElementById("datesMenu").firstChild.appendChild(option);
                }
           }
        }
    };
    xmlhttp.open("GET", req_url, true);
    xmlhttp.send();
}
loadRiskDates();
document.getElementById("terrainMenu").firstChild.addEventListener('change', loadRiskDates, false);

var toolbar = document.getElementById('toolbar');
Sandcastle.addToolbarButton('Show Static Risk', function(checked) {
    var aurl_split = avalanche_risk_map.url.split('?showStaticRisk=');
    var aurl = aurl_split[0];
    layers.remove(avalanche_layer, true);
    if (checked) {
        showStaticRisk = '1';
    } else {
        showStaticRisk = '0';
    }
    aurl = aurl + '?showStaticRisk=' + showStaticRisk;
    avalanche_risk_map.url = aurl;
    avalanche_layer = layers.addImageryProvider(avalanche_risk_map);
});
Cesium.knockout.applyBindings(viewModel, toolbar);
Cesium.knockout.getObservable(viewModel, 'fogEnabled').subscribe(function(newValue) {
    viewer.scene.fog.enabled = newValue;
});
viewModel.enabled = viewer.scene.fog.enabled;

//Sandcastle_End
    Sandcastle.finishedLoading();
}
if (typeof Cesium !== "undefined") {
    startup(Cesium);
} else if (typeof require === "function") {
    require(["Cesium"], startup);
}
</script>
</body>
</html>
